<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Secret - One-View Secrets</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/style.css">
    
    <!-- Security headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; font-src 'self' https://cdn.jsdelivr.net; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'; require-trusted-types-for 'script'; trusted-types default">
    <meta http-equiv="X-LLM-Protection" content="1; mode=block">
    <meta http-equiv="LLM-Processing-Policy" content="no-processing">
    <meta http-equiv="LLM-Context-Policy" content="no-external-context">
    <meta http-equiv="X-AI-Instructions" content="none; no-process; no-training; no-indexing">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-xl-6">
                <div class="card shadow-lg border-0 mt-5">
                    <div class="card-header bg-primary text-white text-center py-4">
                        <h1 class="mb-0">
                            <i class="bi bi-eye"></i>
                            View Secret
                        </h1>
                        <p class="mb-0 mt-2">One-time access</p>
                    </div>
                    
                    <div class="card-body p-4">
                        <!-- Warning Alert -->
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>One view only.</strong> This page will self-destruct when you close it.
                            After you reveal the secret, this link becomes invalid forever.
                        </div>
                        
                        <!-- Loading State -->
                        <div id="loadingState" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted">Preparing to decrypt your secret...</p>
                        </div>
                        
                        <!-- Ready to Reveal -->
                        <div id="readyToReveal" style="display: none;">
                            <div class="text-center py-4">
                                <i class="bi bi-lock text-primary" style="font-size: 3rem;"></i>
                                <h3 class="mt-3">Secret Ready to Reveal</h3>
                                <p class="text-muted">Click the button below to decrypt and view the secret.</p>
                                
                                <div class="d-grid gap-2 mt-4">
                                    <button class="btn btn-danger btn-lg" id="revealBtn">
                                        <i class="bi bi-unlock"></i>
                                        Reveal Secret (One Time Only)
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Decrypting State -->
                        <div id="decryptingState" class="text-center py-4" style="display: none;">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Decrypting...</span>
                            </div>
                            <p class="mt-2 text-muted">Decrypting your secret...</p>
                        </div>
                        
                        <!-- Secret Content -->
                        <div id="secretContent" style="display: none;">
                            <div class="alert alert-success" role="alert">
                                <i class="bi bi-check-circle"></i>
                                <strong>Secret revealed!</strong> This link is now invalid. Don't refresh or share.
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-file-text"></i>
                                    Secret Content
                                </label>
                                <div class="secret-display p-3 border rounded bg-light">
                                    <pre id="secretText" class="mb-0"></pre>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 mb-3">
                                <button class="btn btn-secondary" id="copySecretBtn">
                                    <i class="bi bi-clipboard"></i>
                                    Copy to Clipboard
                                </button>
                            </div>
                            
                            <div class="alert alert-info" role="alert">
                                <i class="bi bi-info-circle"></i>
                                <strong>Security Note:</strong> This secret has been permanently deleted from the server. 
                                Make sure to save it if needed - you cannot access this link again.
                            </div>
                            
                            <div class="text-center">
                                <a href="/" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i>
                                    Create Your Own Secret
                                </a>
                            </div>
                        </div>
                        
                        <!-- Error States -->
                        <div id="errorNotFound" class="text-center py-4" style="display: none;">
                            <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                            <h3 class="mt-3 text-danger">Secret Not Found</h3>
                            <p class="text-muted">
                                Expired or already viewed. Remember, secrets can only be viewed once!
                            </p>
                            <div class="mt-4">
                                <a href="/" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i>
                                    Create a new secret
                                </a>
                            </div>
                        </div>
                        
                        <div id="errorDecryption" class="text-center py-4" style="display: none;">
                            <i class="bi bi-shield-x text-danger" style="font-size: 3rem;"></i>
                            <h3 class="mt-3 text-danger">Decryption Failed</h3>
                            <p class="text-muted">
                                The decryption key appears to be invalid or corrupted. 
                                This could happen if the URL was modified.
                            </p>
                            <div class="mt-4">
                                <a href="/" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i>
                                    Create a new secret
                                </a>
                            </div>
                        </div>
                        
                        <div id="errorGeneral" class="alert alert-danger" style="display: none;" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Error:</strong> <span id="errorMessage"></span>
                        </div>
                    </div>
                    
                    <div class="card-footer text-center text-muted">
                        <small>
                            <i class="bi bi-shield-check"></i>
                            Zero-knowledge decryption • Secure • Self-destructing
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom Scripts -->
    <script src="/static/crypto.js"></script>
    <script src="/static/ai_security.js"></script>
    <script>
        // View page specific functionality
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const secretId = urlParams.get('id');
            const encryptionKey = window.location.hash.substring(1); // Remove #
            
            if (!secretId) {
                showError('errorNotFound');
                return;
            }
            
            if (!encryptionKey) {
                showError('errorDecryption');
                return;
            }
            
            // Show ready to reveal state
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('readyToReveal').style.display = 'block';
            
            // Set up reveal button
            document.getElementById('revealBtn').addEventListener('click', async () => {
                await revealSecret(secretId, encryptionKey);
            });
            
            // Set up copy button
            document.getElementById('copySecretBtn').addEventListener('click', () => {
                const secretText = document.getElementById('secretText').textContent;
                navigator.clipboard.writeText(secretText).then(() => {
                    const btn = document.getElementById('copySecretBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
                    btn.classList.add('btn-success');
                    btn.classList.remove('btn-secondary');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-secondary');
                    }, 2000);
                });
            });
        });
        
        async function revealSecret(secretId, encryptionKey) {
            try {
                // Show decrypting state
                document.getElementById('readyToReveal').style.display = 'none';
                document.getElementById('decryptingState').style.display = 'block';
                
                // Fetch encrypted data from server
                const response = await fetch(`/api/secret/${secretId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        showError('errorNotFound');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                const encryptedData = data.ciphertext;
                
                // Decrypt the data
                const decryptedText = await CryptoManager.decrypt(encryptedData, encryptionKey);
                
                // Show the decrypted secret
                document.getElementById('decryptingState').style.display = 'none';
                document.getElementById('secretText').textContent = decryptedText;
                document.getElementById('secretContent').style.display = 'block';
                
                // Clear the URL hash for security
                history.replaceState(null, null, window.location.pathname + window.location.search);
                
            } catch (error) {
                console.error('Error revealing secret:', error);
                
                if (error.message.includes('decrypt') || error.message.includes('Invalid')) {
                    showError('errorDecryption');
                } else {
                    document.getElementById('errorMessage').textContent = 'Failed to retrieve secret. Please try again.';
                    showError('errorGeneral');
                }
            }
        }
        
        function showError(errorType) {
            // Hide all other states
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('readyToReveal').style.display = 'none';
            document.getElementById('decryptingState').style.display = 'none';
            document.getElementById('secretContent').style.display = 'none';
            document.getElementById('errorNotFound').style.display = 'none';
            document.getElementById('errorDecryption').style.display = 'none';
            document.getElementById('errorGeneral').style.display = 'none';
            
            // Show specific error
            document.getElementById(errorType).style.display = 'block';
        }
    </script>
</body>
</html>
